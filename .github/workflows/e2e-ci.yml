name: E2E Tests

on:
  push:
    branches:
      - main
    paths:
      - 'apps/api/**'
      - 'apps/mobile/**'
      - 'packages/schemas/**'
      - 'packages/database/**'
      - '.github/workflows/e2e-ci.yml'
  pull_request:
    paths:
      - 'apps/api/**'
      - 'apps/mobile/**'
      - 'packages/schemas/**'
      - 'packages/database/**'
      - '.github/workflows/e2e-ci.yml'

permissions:
  actions: read
  contents: read

jobs:
  api-integration:
    name: API Integration Tests
    runs-on: ubuntu-latest
    # Advisory — does not block PR merge
    continue-on-error: true
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: eduagent
          POSTGRES_PASSWORD: eduagent
          POSTGRES_DB: tests
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    env:
      DATABASE_URL: postgresql://eduagent:eduagent@localhost:5432/tests
      CI: true
    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        with:
          standalone: true

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - run: pnpm install

      - name: Apply database schema
        run: pnpm --filter @eduagent/database db:push

      - name: Run API integration tests
        run: pnpm exec nx run api:test:integration

  mobile-maestro:
    name: Mobile Maestro Smoke Tests
    runs-on: ubuntu-latest
    # Advisory — does not block PR merge
    continue-on-error: true
    timeout-minutes: 30
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: eduagent
          POSTGRES_PASSWORD: eduagent
          POSTGRES_DB: tests
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    env:
      MAESTRO_CLI_NO_ANALYTICS: 1
      DATABASE_URL: postgresql://eduagent:eduagent@localhost:5432/tests
      NODE_ENV: test
      CI: true
    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0

      - uses: pnpm/action-setup@v4
        with:
          standalone: true

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # React Native native builds (Gradle) run `node` scripts that expect
      # flat node_modules. pnpm's default isolated layout breaks this.
      # Hoist only in CI — local dev keeps strict isolation.
      - name: Configure pnpm for native builds
        run: echo "shamefully-hoist=true" > .npmrc

      - run: pnpm install

      # Build workspace deps that the mobile app imports at prebuild time
      - name: Build schemas package
        run: pnpm exec nx run schemas:build

      # Apply database schema for seed endpoint and API routes
      - name: Apply database schema
        run: pnpm --filter @eduagent/database db:push

      # Start API server in background (NODE_ENV=test enables __test/* routes)
      - name: Start API server (background)
        run: |
          pnpm exec nx dev api &
          echo "Waiting for API server..."
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8787/v1/health > /dev/null 2>&1; then
              echo "API server ready"
              break
            fi
            sleep 1
          done

      # Generate native Android project from Expo config
      - name: Expo prebuild (Android)
        working-directory: apps/mobile
        run: npx expo prebuild --platform android --no-install

      # Bundle JS into the APK so the app works without a Metro dev server.
      # Debug builds normally fetch JS from Metro at runtime, but in CI
      # there is no Metro server. Pre-bundling embeds the JS in the APK.
      # Uses `expo export:embed` instead of `react-native bundle` because
      # Expo replaces @react-native/metro-config with @expo/metro-config.
      - name: Bundle JS for offline APK
        working-directory: apps/mobile
        run: |
          mkdir -p android/app/src/main/assets
          node ../../node_modules/@expo/cli/build/bin/cli export:embed \
            --platform android \
            --dev false \
            --entry-file index.js \
            --bundle-output android/app/src/main/assets/index.android.bundle \
            --assets-dest android/app/src/main/res

      # Compile debug APK via Gradle (now includes the pre-bundled JS)
      - name: Build debug APK
        working-directory: apps/mobile/android
        run: ./gradlew assembleDebug --no-daemon --stacktrace

      - name: Install Maestro CLI
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> "$GITHUB_PATH"

      # Enable KVM for hardware-accelerated Android emulator (10x faster boot)
      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Run Maestro smoke tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          emulator-options: -no-window -gpu swiftshader_indirect -no-snapshot -noaudio -no-boot-anim
          script: |
            adb install apps/mobile/android/app/build/outputs/apk/debug/app-debug.apk
            maestro test apps/mobile/e2e/flows/ --include-tags=smoke
        env:
          API_URL: http://10.0.2.2:8787
