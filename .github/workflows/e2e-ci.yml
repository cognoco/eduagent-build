name: E2E Tests

on:
  push:
    branches:
      - main
    paths:
      - 'apps/api/**'
      - 'apps/mobile/**'
      - 'packages/schemas/**'
      - 'packages/database/**'
      - '.github/workflows/e2e-ci.yml'
  pull_request:
    paths:
      - 'apps/api/**'
      - 'apps/mobile/**'
      - 'packages/schemas/**'
      - 'packages/database/**'
      - '.github/workflows/e2e-ci.yml'

permissions:
  actions: read
  contents: read

jobs:
  api-integration:
    name: API Integration Tests
    runs-on: ubuntu-latest
    # Advisory — does not block PR merge
    continue-on-error: true
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: eduagent
          POSTGRES_PASSWORD: eduagent
          POSTGRES_DB: tests
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    env:
      DATABASE_URL: postgresql://eduagent:eduagent@localhost:5432/tests
      CI: true
    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        with:
          standalone: true

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - run: pnpm install

      - name: Apply database schema
        run: pnpm --filter @eduagent/database db:push

      - name: Run API integration tests
        run: pnpm exec nx run api:test:integration

  mobile-maestro:
    name: Mobile Maestro Smoke Tests
    runs-on: ubuntu-latest
    # Advisory — does not block PR merge
    continue-on-error: true
    timeout-minutes: 30
    env:
      MAESTRO_CLI_NO_ANALYTICS: 1
    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0

      - uses: pnpm/action-setup@v4
        with:
          standalone: true

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - run: pnpm install

      # Build workspace deps that the mobile app imports at prebuild time
      - name: Build schemas package
        run: pnpm exec nx run schemas:build

      # Generate native Android project from Expo config
      - name: Expo prebuild (Android)
        working-directory: apps/mobile
        run: npx expo prebuild --platform android --no-install

      # Compile debug APK via Gradle
      - name: Build debug APK
        working-directory: apps/mobile/android
        run: ./gradlew assembleDebug --no-daemon

      - name: Install Maestro CLI
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> "$GITHUB_PATH"

      # Enable KVM for hardware-accelerated Android emulator (10x faster boot)
      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Run Maestro smoke tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          emulator-options: -no-window -gpu swiftshader_indirect -no-snapshot -noaudio -no-boot-anim
          script: |
            adb install apps/mobile/android/app/build/outputs/apk/debug/app-debug.apk
            maestro test apps/mobile/e2e/flows/ --include-tags=smoke
