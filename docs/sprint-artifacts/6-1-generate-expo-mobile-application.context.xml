<story-context id="bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>1</storyId>
    <title>Generate Expo Mobile Application</title>
    <status>drafted</status>
    <generatedAt>2025-12-13</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/6-1-generate-expo-mobile-application.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>generate an Expo mobile application using the @nx/expo generator</iWant>
    <soThat>I have a properly scaffolded mobile app integrated into the Nx monorepo with correct dependencies and configuration</soThat>
    <tasks>
      <task id="1" ac="1">
        <title>Generate Expo Application</title>
        <subtasks>
          <subtask id="1.1">Run `pnpm exec nx g @nx/expo:application mobile --directory=apps/mobile`</subtask>
          <subtask id="1.2">Verify generator completes without errors</subtask>
          <subtask id="1.3">Verify `apps/mobile/` directory structure matches expected Expo Router layout</subtask>
          <subtask id="1.4">Verify `project.json` contains correct Nx targets (start, build, lint, test, etc.)</subtask>
        </subtasks>
      </task>
      <task id="2" ac="3,4">
        <title>Apply Post-Generation Checklist</title>
        <subtasks>
          <subtask id="2.1">Check `tsconfig.json` for correct `moduleResolution` setting</subtask>
          <subtask id="2.2">Verify Jest configuration aligns with workspace patterns</subtask>
          <subtask id="2.3">Review `metro.config.js` for monorepo compatibility (SDK 52+ auto-config expected)</subtask>
          <subtask id="2.4">Ensure `app.json` has correct Expo configuration</subtask>
          <subtask id="2.5">Document any deviations from expected patterns in Dev Notes</subtask>
        </subtasks>
      </task>
      <task id="3" ac="5">
        <title>Verify TypeScript Path Aliases</title>
        <subtasks>
          <subtask id="3.1">Create test file: `apps/mobile/src/lib/api.ts`</subtask>
          <subtask id="3.2">Add import: `import type { paths } from '@nx-monorepo/api-client';`</subtask>
          <subtask id="3.3">Run `pnpm exec nx run mobile:typecheck` or verify no IDE errors</subtask>
          <subtask id="3.4">Verify `tsconfig.base.json` paths are recognized by Metro</subtask>
        </subtasks>
      </task>
      <task id="4" ac="6">
        <title>Validate React Version Alignment</title>
        <subtasks>
          <subtask id="4.1">Run `pnpm why react` - expect single version 19.1.0</subtask>
          <subtask id="4.2">Run `pnpm why react-native` - expect version 0.81.5</subtask>
          <subtask id="4.3">If multiple versions detected, resolve via pnpm overrides (already in place from Epic 5b)</subtask>
        </subtasks>
      </task>
      <task id="5" ac="2">
        <title>Start Expo Dev Server</title>
        <subtasks>
          <subtask id="5.1">Run `pnpm exec nx run mobile:start`</subtask>
          <subtask id="5.2">Verify Expo CLI starts and displays QR code</subtask>
          <subtask id="5.3">Test Metro bundler loads without errors</subtask>
          <subtask id="5.4">Document any startup warnings for troubleshooting guide</subtask>
        </subtasks>
      </task>
      <task id="6" ac="3,4">
        <title>Run Lint and Test</title>
        <subtasks>
          <subtask id="6.1">Run `pnpm exec nx run mobile:lint` - expect pass</subtask>
          <subtask id="6.2">Run `pnpm exec nx run mobile:test` - expect pass (default tests)</subtask>
          <subtask id="6.3">Fix any linting or test failures</subtask>
          <subtask id="6.4">Document test count and coverage baseline</subtask>
        </subtasks>
      </task>
      <task id="7" ac="7">
        <title>Validate Nx Graph Integration</title>
        <subtasks>
          <subtask id="7.1">Run `pnpm exec nx graph`</subtask>
          <subtask id="7.2">Verify `mobile` app appears in graph</subtask>
          <subtask id="7.3">Verify dependency relationships are correct (mobile depends on shared packages)</subtask>
          <subtask id="7.4">Take screenshot or note graph structure for documentation</subtask>
        </subtasks>
      </task>
      <task id="8" ac="all">
        <title>Update Documentation</title>
        <subtasks>
          <subtask id="8.1">Update sprint-status.yaml: set 6-1 status to done</subtask>
          <subtask id="8.2">Document any issues encountered in Dev Notes</subtask>
          <subtask id="8.3">Note any @nx/expo generator quirks or workarounds for future reference</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-6.1.1">
      <description>`pnpm exec nx g @nx/expo:application mobile --directory=apps/mobile` succeeds without errors</description>
      <validation>Generator completes, apps/mobile/ directory created with Expo Router structure</validation>
    </criterion>
    <criterion id="AC-6.1.2">
      <description>`pnpm exec nx run mobile:start` launches Expo dev server and displays QR code</description>
      <validation>QR code visible in terminal, Metro bundler running</validation>
    </criterion>
    <criterion id="AC-6.1.3">
      <description>`pnpm exec nx run mobile:lint` passes with no errors</description>
      <validation>Zero lint errors reported</validation>
    </criterion>
    <criterion id="AC-6.1.4">
      <description>`pnpm exec nx run mobile:test` passes (default generated tests)</description>
      <validation>All tests pass, no failures</validation>
    </criterion>
    <criterion id="AC-6.1.5">
      <description>TypeScript path aliases resolve correctly (can import from `@nx-monorepo/*` packages)</description>
      <validation>No TypeScript errors when importing from shared packages</validation>
    </criterion>
    <criterion id="AC-6.1.6">
      <description>Single React version validated (`pnpm why react` shows only 19.1.0)</description>
      <validation>Only react@19.1.0 appears in dependency tree</validation>
    </criterion>
    <criterion id="AC-6.1.7">
      <description>`nx graph` shows mobile app with correct dependency relationships</description>
      <validation>Mobile app visible in graph, depends on shared packages (api-client, schemas)</validation>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-6.md</path>
        <title>Epic 6 Technical Specification</title>
        <section>All sections - authoritative spec for mobile walking skeleton</section>
        <snippet>Defines SDK 54 requirements, project structure (apps/mobile/), Metro auto-configuration, and story acceptance criteria. Revised 2025-12-13 for SDK 54.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/epic-6-design-decisions.md</path>
        <title>Epic 6 Design Decisions</title>
        <section>D1-D6 - SDK, Navigation, Generation, Metro, API, Architecture decisions</section>
        <snippet>SDK 54 (stable), Expo Router v6, @nx/expo:application generator, automatic Metro config, openapi-fetch API client, Legacy Architecture strategy.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Project Structure, Dependency Flow</section>
        <snippet>Mobile app extends dependency flow: apps/mobile → packages/api-client → packages/schemas. No app-to-app imports allowed.</snippet>
      </doc>
      <doc>
        <path>docs/memories/post-generation-checklist/post-generation-checklist.core.md</path>
        <title>Post-Generation Checklist</title>
        <section>Module Index</section>
        <snippet>Apply checklist after generator runs. Check Jest config, TypeScript settings, project targets. Prevents pattern drift.</snippet>
      </doc>
      <doc>
        <path>docs/memories/testing-reference/testing-reference.core.md</path>
        <title>Testing Reference</title>
        <section>Critical Rules, Module Index</section>
        <snippet>Co-located test files in src/**, use jest-expo preset for mobile, naming convention *.spec.ts/*.spec.tsx.</snippet>
      </doc>
      <doc>
        <path>docs/tech-stack.md</path>
        <title>Technology Stack</title>
        <section>Version Matrix</section>
        <snippet>Expo SDK 54.0.x, React Native 0.81.5, React 19.1.0, @nx/expo 22.2.0, TypeScript ~5.9.2.</snippet>
      </doc>
    </docs>
    <code>
      <codeRef>
        <path>packages/api-client/src/index.ts</path>
        <kind>library</kind>
        <symbol>createClient</symbol>
        <lines>N/A</lines>
        <reason>Mobile app will import openapi-fetch client from this package for type-safe API calls</reason>
      </codeRef>
      <codeRef>
        <path>packages/api-client/src/generated/api-types.ts</path>
        <kind>types</kind>
        <symbol>paths</symbol>
        <lines>N/A</lines>
        <reason>TypeScript types generated from OpenAPI spec - mobile will use for type-safe API calls</reason>
      </codeRef>
      <codeRef>
        <path>packages/schemas/src/lib/health.schema.ts</path>
        <kind>schema</kind>
        <symbol>HealthCheckSchema, CreateHealthCheckSchema</symbol>
        <lines>N/A</lines>
        <reason>Zod schemas for health check validation - mobile will reuse same schemas as web</reason>
      </codeRef>
      <codeRef>
        <path>apps/web/src/lib/api.ts</path>
        <kind>utility</kind>
        <symbol>apiClient</symbol>
        <lines>N/A</lines>
        <reason>Reference pattern for API client configuration - mobile will create similar file with environment-aware URL</reason>
      </codeRef>
      <codeRef>
        <path>tsconfig.base.json</path>
        <kind>config</kind>
        <symbol>paths</symbol>
        <lines>N/A</lines>
        <reason>Workspace path aliases (@nx-monorepo/*) - mobile must recognize these via Metro</reason>
      </codeRef>
      <codeRef>
        <path>nx.json</path>
        <kind>config</kind>
        <symbol>@nx/expo/plugin</symbol>
        <lines>N/A</lines>
        <reason>Nx plugin configuration for Expo - defines target names (start, build, lint, test, etc.)</reason>
      </codeRef>
      <codeRef>
        <path>package.json</path>
        <kind>manifest</kind>
        <symbol>pnpm.overrides</symbol>
        <lines>N/A</lines>
        <reason>React 19.1.0 enforced via overrides - ensures single React version across web and mobile</reason>
      </codeRef>
    </code>
    <dependencies>
      <node>
        <package>expo</package>
        <version>~54.0.0</version>
        <purpose>Expo SDK and CLI</purpose>
      </node>
      <node>
        <package>react-native</package>
        <version>0.81.5</version>
        <purpose>Mobile framework (bundled with SDK 54)</purpose>
      </node>
      <node>
        <package>react</package>
        <version>19.1.0</version>
        <purpose>UI library (aligned with web via pnpm overrides)</purpose>
      </node>
      <node>
        <package>expo-router</package>
        <version>~6.0.17</version>
        <purpose>File-based navigation (bundled with SDK 54)</purpose>
      </node>
      <node>
        <package>expo-constants</package>
        <version>bundled</version>
        <purpose>Environment configuration access</purpose>
      </node>
      <node>
        <package>@nx/expo</package>
        <version>22.2.0</version>
        <purpose>Nx plugin for Expo generators and executors</purpose>
      </node>
      <dev>
        <package>jest-expo</package>
        <version>bundled</version>
        <purpose>Jest preset for Expo projects</purpose>
      </dev>
      <dev>
        <package>@testing-library/react-native</package>
        <version>latest</version>
        <purpose>Component testing utilities (add via post-generation checklist)</purpose>
      </dev>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="tech-spec-epic-6.md">
      <rule>SDK 54 required - @nx/expo 22.2.0 requires expo >= 54.0.0</rule>
    </constraint>
    <constraint source="epic-6-design-decisions.md">
      <rule>Legacy Architecture - SDK 54 is last version supporting Legacy Architecture; do not enable New Architecture</rule>
    </constraint>
    <constraint source="epic-6-design-decisions.md">
      <rule>Metro auto-configuration - Since SDK 52, no manual watchFolders configuration needed</rule>
    </constraint>
    <constraint source="architecture.md">
      <rule>No app-to-app imports - Mobile must not import from web app; use shared packages only</rule>
    </constraint>
    <constraint source="architecture.md">
      <rule>Buildable libraries - All packages must be buildable with proper TypeScript exports</rule>
    </constraint>
    <constraint source="package.json">
      <rule>Single React version - pnpm overrides enforce React 19.1.0 monorepo-wide</rule>
    </constraint>
    <constraint source="post-generation-checklist">
      <rule>Apply checklist after generation - Verify Jest, TypeScript, and project targets align with workspace patterns</rule>
    </constraint>
    <constraint source="story">
      <rule>Walking skeleton scope - Use out-of-the-box Expo Router structure; do not introduce custom navigation patterns</rule>
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>@nx/expo:application generator</name>
      <kind>CLI generator</kind>
      <signature>pnpm exec nx g @nx/expo:application mobile --directory=apps/mobile</signature>
      <path>N/A (installed plugin)</path>
    </interface>
    <interface>
      <name>Expo CLI targets</name>
      <kind>Nx targets</kind>
      <signature>start, build, prebuild, serve, install, export, submit, run-ios, run-android, build-deps, watch-deps</signature>
      <path>nx.json (@nx/expo/plugin options)</path>
    </interface>
    <interface>
      <name>openapi-fetch client</name>
      <kind>TypeScript API</kind>
      <signature>createClient&lt;paths&gt;({ baseUrl })</signature>
      <path>packages/api-client/src/index.ts</path>
    </interface>
    <interface>
      <name>Health Check API</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/health, POST /api/health</signature>
      <path>apps/server/src/routes/health.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Use Jest with jest-expo preset for mobile unit tests. Tests are co-located in src/ directory next to source files with *.spec.ts or *.spec.tsx naming convention. Follow workspace testing patterns from docs/memories/testing-reference/. Walking skeleton target is 60% coverage (not enforced). UI testing libraries (jest-dom, user-event equivalent for RN: @testing-library/react-native) should be added via post-generation checklist.
    </standards>
    <locations>
      <location>apps/mobile/src/**/*.spec.ts</location>
      <location>apps/mobile/src/**/*.spec.tsx</location>
      <location>apps/mobile/app/**/*.spec.tsx (if Expo Router tests needed)</location>
    </locations>
    <ideas>
      <testIdea ac="AC-6.1.1">
        <description>Verify generator output structure matches expected Expo Router layout</description>
        <type>validation</type>
      </testIdea>
      <testIdea ac="AC-6.1.3">
        <description>Run lint on generated code to catch any ESLint configuration issues</description>
        <type>lint</type>
      </testIdea>
      <testIdea ac="AC-6.1.4">
        <description>Default generated tests pass - validates Jest + jest-expo configuration</description>
        <type>unit</type>
      </testIdea>
      <testIdea ac="AC-6.1.5">
        <description>Create test file with @nx-monorepo/* import to verify path alias resolution</description>
        <type>integration</type>
      </testIdea>
      <testIdea ac="AC-6.1.6">
        <description>Run pnpm why react to verify single version - automated in validation script</description>
        <type>validation</type>
      </testIdea>
      <testIdea ac="AC-6.1.7">
        <description>Use nx graph to verify mobile app dependency relationships</description>
        <type>validation</type>
      </testIdea>
    </ideas>
  </tests>
</story-context>
