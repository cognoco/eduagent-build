<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>7</storyId>
    <title>Validate Mobile Deployment Pipeline</title>
    <status>drafted</status>
    <generatedAt>2025-12-13</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/6-7-validate-mobile-deployment-pipeline.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>stakeholder reviewing mobile CI/CD implementation</asA>
    <iWant>to verify the mobile CI pipeline works correctly</iWant>
    <soThat>I have confidence mobile app quality is maintained automatically</soThat>
    <tasks>
      <task id="1" name="Validate Smart Trigger Behavior">
        <subtasks>
          <subtask>1.1 Create test branch modifying only apps/web/ file</subtask>
          <subtask>1.2 Open PR and verify mobile-ci.yml workflow does NOT run</subtask>
          <subtask>1.3 Create second test branch modifying apps/mobile/ file</subtask>
          <subtask>1.4 Open PR and verify mobile-ci.yml workflow DOES run</subtask>
          <subtask>1.5 Test with packages/api-client/ change to verify shared package detection</subtask>
          <subtask>1.6 Document results in story file</subtask>
        </subtasks>
        <acceptanceCriteria>AC-6.7.1, AC-6.7.2</acceptanceCriteria>
      </task>
      <task id="2" name="Validate Lint Gate">
        <subtasks>
          <subtask>2.1 Create branch with intentional ESLint violation in apps/mobile/</subtask>
          <subtask>2.2 Open PR and verify lint job fails</subtask>
          <subtask>2.3 Verify PR is blocked from merge (required status check)</subtask>
          <subtask>2.4 Fix lint error and verify job passes on re-run</subtask>
          <subtask>2.5 Document behavior in story file</subtask>
        </subtasks>
        <acceptanceCriteria>AC-6.7.3</acceptanceCriteria>
      </task>
      <task id="3" name="Validate Test Gate">
        <subtasks>
          <subtask>3.1 Create branch with intentional test failure in apps/mobile/</subtask>
          <subtask>3.2 Open PR and verify test job fails</subtask>
          <subtask>3.3 Verify PR is blocked from merge</subtask>
          <subtask>3.4 Fix test and verify job passes on re-run</subtask>
          <subtask>3.5 Document behavior in story file</subtask>
        </subtasks>
        <acceptanceCriteria>AC-6.7.4</acceptanceCriteria>
      </task>
      <task id="4" name="Validate EAS Build Integration">
        <subtasks>
          <subtask>4.1 Merge a PR with mobile changes to main branch</subtask>
          <subtask>4.2 Verify EAS preview build job triggers automatically</subtask>
          <subtask>4.3 Wait for build completion (expect 10-20 minutes)</subtask>
          <subtask>4.4 Verify build artifact accessible from Expo dashboard</subtask>
          <subtask>4.5 Download and verify APK is installable (optional: emulator test)</subtask>
          <subtask>4.6 Document EAS build timing and URL in story file</subtask>
        </subtasks>
        <acceptanceCriteria>AC-6.7.5, AC-6.7.6</acceptanceCriteria>
      </task>
      <task id="5" name="Validate Nx Cloud Integration">
        <subtasks>
          <subtask>5.1 Run mobile lint twice in CI (separate commits)</subtask>
          <subtask>5.2 Check Nx Cloud dashboard for mobile task entries</subtask>
          <subtask>5.3 Verify cache hit on second run (reduced execution time)</subtask>
          <subtask>5.4 Document cache behavior in story file</subtask>
        </subtasks>
        <acceptanceCriteria>AC-6.7.7</acceptanceCriteria>
      </task>
      <task id="6" name="Validate No Regression">
        <subtasks>
          <subtask>6.1 Review main ci.yml workflow logs during validation period</subtask>
          <subtask>6.2 Verify web and server lint, test, build, e2e still pass</subtask>
          <subtask>6.3 Confirm no new warnings or errors introduced</subtask>
          <subtask>6.4 Document any observations in story file</subtask>
        </subtasks>
        <acceptanceCriteria>AC-6.7.8</acceptanceCriteria>
      </task>
      <task id="7" name="Document CI Timing and Summary">
        <subtasks>
          <subtask>7.1 Record timing for each CI stage</subtask>
          <subtask>7.2 Create summary table in story file</subtask>
          <subtask>7.3 Update README or docs with mobile CI documentation</subtask>
          <subtask>7.4 Note any recommendations for optimization</subtask>
        </subtasks>
        <acceptanceCriteria>AC-6.7.9</acceptanceCriteria>
      </task>
      <task id="8" name="Update Sprint Status">
        <subtasks>
          <subtask>8.1 Update sprint-status.yaml: set 6-7 status to done</subtask>
          <subtask>8.2 Update epic-6 status if all stories complete</subtask>
          <subtask>8.3 Document completion notes in Dev Agent Record</subtask>
        </subtasks>
        <acceptanceCriteria>all</acceptanceCriteria>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-6.7.1">PR touching only apps/web/ does NOT trigger mobile CI workflow</criterion>
    <criterion id="AC-6.7.2">PR touching apps/mobile/ triggers mobile lint and test jobs</criterion>
    <criterion id="AC-6.7.3">Intentional lint failure blocks PR merge</criterion>
    <criterion id="AC-6.7.4">Intentional test failure blocks PR merge</criterion>
    <criterion id="AC-6.7.5">Merge to main triggers EAS preview build (Android)</criterion>
    <criterion id="AC-6.7.6">Build artifact accessible from Expo dashboard</criterion>
    <criterion id="AC-6.7.7">Nx Cloud shows mobile task caching working</criterion>
    <criterion id="AC-6.7.8">No regression in existing web/server CI pipeline</criterion>
    <criterion id="AC-6.7.9">Mobile CI timing documented (expected: ~15-25 min with EAS build)</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/sprint-artifacts/tech-spec-epic-6.md" title="Epic 6 Tech Spec" section="CI/CD Implementation (Stories 6.6-6.7)">
        Comprehensive mobile CI/CD implementation spec: separate workflow file architecture, Nx affected detection, EAS build profiles, secrets management, expected timing (lint+test 2-3 min, EAS build 10-20 min, total ~15-25 min)
      </doc>
      <doc path="docs/mobile-environment-strategy.md" title="Mobile Environment Strategy" section="CI/CD Integration">
        Primary CI/CD documentation: workflow structure (ci.yml for web/server, mobile-ci.yml for mobile), smart triggers with path filters, CI flow diagram, EAS build integration, EXPO_TOKEN secret configuration
      </doc>
      <doc path="docs/sprint-artifacts/6-6-mobile-cicd-pipeline-integration.md" title="Story 6.6: Mobile CI/CD Pipeline Integration" section="Full document">
        Prerequisite story that creates mobile-ci.yml workflow. Status: ready-for-dev. Contains detailed implementation tasks and CI flow diagrams. Story 6.7 validates Story 6.6's deliverables.
      </doc>
      <doc path="docs/sprint-artifacts/6-6-mobile-cicd-pipeline-integration.context.xml" title="Story 6.6 Context" section="Full context">
        Development context for prerequisite story, includes code artifacts and interface references
      </doc>
      <doc path="docs/epics.md" title="Epic Breakdown" section="Story 6.7: Validate Mobile Deployment Pipeline">
        Original story definition with acceptance criteria and technical notes. Emphasizes this is a validation story, not implementation.
      </doc>
    </docs>
    <code>
      <artifact path=".github/workflows/ci.yml" kind="workflow" symbol="N/A" lines="full" reason="Existing web/server CI workflow - verify no regression (AC-6.7.8)"/>
      <artifact path=".github/workflows/mobile-ci.yml" kind="workflow" symbol="N/A" lines="TBD" reason="TARGET FILE: Created by Story 6.6, validated by this story. Does NOT exist until 6.6 is implemented."/>
      <artifact path="apps/mobile/eas.json" kind="config" symbol="N/A" lines="full" reason="EAS build profiles - verify preview profile triggers correctly (AC-6.7.5, AC-6.7.6)"/>
      <artifact path="apps/mobile/project.json" kind="config" symbol="N/A" lines="full" reason="Nx project config - verify lint/test/typecheck targets exist for affected detection"/>
      <artifact path="apps/mobile/src/**/*.ts" kind="source" symbol="N/A" lines="TBD" reason="Mobile source files - create intentional lint/test failures here for gate validation"/>
      <artifact path="apps/mobile/src/**/*.spec.ts" kind="test" symbol="N/A" lines="TBD" reason="Mobile test files - create intentional test failures for gate validation"/>
    </code>
    <dependencies>
      <ecosystem name="npm">
        <package name="expo" version="~54.0.0" purpose="Expo SDK - EAS Build target"/>
        <package name="eas-cli" version="latest" purpose="EAS CLI for cloud builds"/>
        <package name="@nx/expo" version="22.2.0" purpose="Nx plugin for Expo"/>
        <package name="jest" version="30.x" purpose="Test framework for mobile tests"/>
        <package name="eslint" version="9.x" purpose="Linting for mobile code"/>
      </ecosystem>
      <services>
        <service name="GitHub Actions" purpose="CI/CD platform running mobile-ci.yml"/>
        <service name="EAS Build" purpose="Cloud build service for mobile artifacts"/>
        <service name="Expo Dashboard" purpose="Build artifact hosting and access"/>
        <service name="Nx Cloud" purpose="Remote caching and task distribution"/>
      </services>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="Tech Spec" type="platform">Android-only for PoC/Phase 2. iOS builds deferred until hardware available.</constraint>
    <constraint source="Tech Spec" type="prerequisite">Story 6.6 MUST be implemented first - it creates mobile-ci.yml that this story validates</constraint>
    <constraint source="Architecture" type="workflow">Mobile CI uses separate workflow file (.github/workflows/mobile-ci.yml) to avoid blocking web/server PRs</constraint>
    <constraint source="Tech Spec" type="timing">EAS builds take 10-20 minutes - validation must account for this</constraint>
    <constraint source="Secrets" type="authentication">EXPO_TOKEN must be configured as GitHub secret before EAS builds work</constraint>
    <constraint source="Sprint Status" type="dependency">Story 6.6 is at ready-for-dev status, blocking this validation story</constraint>
  </constraints>

  <interfaces>
    <interface name="mobile-ci.yml" kind="GitHub Actions workflow" path=".github/workflows/mobile-ci.yml">
      Triggers: on push to main, PR with paths [apps/mobile/**, packages/api-client/**, packages/schemas/**]
      Jobs: check-affected, lint (if affected), test (if affected), build-preview (on main merge)
      Secrets: EXPO_TOKEN
    </interface>
    <interface name="Nx Affected Detection" kind="CLI command" path="N/A">
      Command: pnpm exec nx show projects --affected --base=origin/main
      Output: List of affected projects including 'mobile' when relevant files change
    </interface>
    <interface name="EAS Build CLI" kind="CLI command" path="N/A">
      Command: eas build --profile preview --platform android --non-interactive
      Triggered by: merge to main in mobile-ci.yml
      Output: Build artifact on Expo dashboard
    </interface>
    <interface name="GitHub Branch Protection" kind="GitHub setting" path="N/A">
      Required status checks: mobile-ci lint, mobile-ci test
      Purpose: Block PR merge on failure (AC-6.7.3, AC-6.7.4)
    </interface>
  </interfaces>

  <tests>
    <standards>
      This is a VALIDATION story, not a feature implementation. Testing approach:
      1. Positive testing: Verify expected behavior when mobile code changes
      2. Negative testing: Verify gates block bad code (intentional failures)
      3. Boundary testing: Verify non-mobile changes don't trigger mobile CI
      4. Performance testing: Document timing characteristics
      5. Integration testing: Verify EAS Build and Nx Cloud work together
      No unit tests - all validation is manual with documented evidence.
    </standards>
    <locations>
      <location>Story file itself (docs/sprint-artifacts/6-7-validate-mobile-deployment-pipeline.md)</location>
      <location>GitHub Actions run logs (referenced in story completion)</location>
      <location>Expo Dashboard (build artifact URLs)</location>
      <location>Nx Cloud Dashboard (cache hit verification)</location>
    </locations>
    <ideas>
      <testIdea forAC="AC-6.7.1">Create minimal change to apps/web/page.tsx (add comment), open PR, screenshot showing mobile-ci workflow NOT triggered</testIdea>
      <testIdea forAC="AC-6.7.2">Create minimal change to apps/mobile/app/index.tsx, open PR, screenshot showing mobile-ci workflow running</testIdea>
      <testIdea forAC="AC-6.7.3">Add ESLint-violating code (unused variable, missing semicolon per config), PR shows lint job failed, merge blocked</testIdea>
      <testIdea forAC="AC-6.7.4">Add failing test (expect(true).toBe(false)), PR shows test job failed, merge blocked</testIdea>
      <testIdea forAC="AC-6.7.5, AC-6.7.6">Merge passing PR to main, verify EAS build job triggers, capture build URL from logs or Expo dashboard</testIdea>
      <testIdea forAC="AC-6.7.7">Run mobile:lint twice (two separate commits), compare Nx Cloud dashboard showing cache hit on second run</testIdea>
      <testIdea forAC="AC-6.7.8">During validation period, verify ci.yml runs pass for web/server projects, no new failures introduced</testIdea>
      <testIdea forAC="AC-6.7.9">Collect timing from CI logs, populate summary table in story file: check-affected, lint, test, EAS build durations</testIdea>
    </ideas>
  </tests>
</story-context>
