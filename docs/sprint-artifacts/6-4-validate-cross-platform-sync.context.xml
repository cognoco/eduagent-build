<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>4</storyId>
    <title>Validate Cross-Platform Sync</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-13</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/6-4-validate-cross-platform-sync.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>product owner</asA>
    <iWant>verify that health check data syncs correctly between web and mobile platforms</iWant>
    <soThat>I have confidence in cross-platform functionality and shared infrastructure</soThat>
    <tasks>
      <task id="1" ac="1-4">Prepare Test Environment - Ensure server, web, and mobile apps are running</task>
      <task id="2" ac="1,3,4">Test Web → Mobile Sync - Create health check on web, verify on mobile</task>
      <task id="3" ac="2,3,4">Test Mobile → Web Sync - Create health check on mobile, verify on web</task>
      <task id="4" ac="3,4">Validate Data Integrity - Verify UUIDs, timestamps, and ordering</task>
      <task id="5" ac="1-4">Test iOS Simulator - Run all sync tests on iOS</task>
      <task id="6" ac="1-4">Test Android Emulator - Run all sync tests on Android (10.0.2.2)</task>
      <task id="7" ac="5,6">Document Validation Results - Screenshots, test dates, limitations</task>
      <task id="8" ac="5" optional="true">Screen Recording - Optional video capture of sync test</task>
      <task id="9" ac="all">Update Sprint Status - Mark 6-4 as done in sprint-status.yaml</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="6.4.1">Web creates ping → Mobile sees it immediately (after manual refresh)</criterion>
    <criterion id="6.4.2">Mobile creates ping → Web sees it immediately (after page refresh)</criterion>
    <criterion id="6.4.3">Same data displayed on both platforms (message, ID, timestamp)</criterion>
    <criterion id="6.4.4">Timestamps and UUIDs match exactly between platforms</criterion>
    <criterion id="6.4.5">Validation documented with screenshots or video recording</criterion>
    <criterion id="6.4.6">Any sync limitations or latency observations documented</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-6.md</path>
        <title>Epic 6 Technical Specification</title>
        <section>Story 6.4: Validate Cross-Platform Sync</section>
        <snippet>Authoritative ACs: Web creates ping → Mobile sees it, Mobile creates ping → Web sees it, Same data on both platforms, Timestamps and IDs match exactly.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/epic-6-design-decisions.md</path>
        <title>Epic 6 Design Decisions</title>
        <section>D5: API Client Approach, Environment URL Configuration</section>
        <snippet>iOS Simulator uses localhost:4000, Android Emulator uses 10.0.2.2:4000. Both platforms use openapi-fetch for type-safe API calls.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Dependency Flow, Implementation Patterns</section>
        <snippet>Apps (web, mobile) → api-client → schemas. All data flows through Express API, never direct client → database.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 6.4: Validate Cross-Platform Sync</section>
        <snippet>Manual validation story - document sync with screenshots/recording, note any sync issues as known limitations.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>apps/web/src/app/health/page.tsx</path>
        <kind>page</kind>
        <symbol>HealthPage</symbol>
        <reason>Web health check page - used to create pings and verify mobile-created data appears</reason>
      </artifact>
      <artifact>
        <path>apps/mobile/app/index.tsx</path>
        <kind>screen</kind>
        <symbol>HomeScreen</symbol>
        <reason>Mobile health check screen (created in 6.3) - used to create pings and verify web-created data appears</reason>
      </artifact>
      <artifact>
        <path>apps/mobile/src/lib/api.ts</path>
        <kind>config</kind>
        <symbol>API_CONFIG</symbol>
        <reason>Mobile API client configuration - environment-aware URL (localhost for iOS, 10.0.2.2 for Android)</reason>
      </artifact>
      <artifact>
        <path>apps/server/src/routes/health.ts</path>
        <kind>route</kind>
        <symbol>healthRouter</symbol>
        <reason>Server health endpoints - GET /health (list) and POST /health/ping (create)</reason>
      </artifact>
      <artifact>
        <path>apps/server/src/controllers/health.controller.ts</path>
        <kind>controller</kind>
        <symbol>HealthController</symbol>
        <reason>Business logic for health check CRUD - shared by web and mobile</reason>
      </artifact>
      <artifact>
        <path>packages/database/src/health.ts</path>
        <kind>repository</kind>
        <symbol>getAllHealthChecks, createHealthCheck</symbol>
        <reason>Database queries - Prisma operations against Supabase PostgreSQL</reason>
      </artifact>
      <artifact>
        <path>packages/schemas/src/lib/health.schema.ts</path>
        <kind>schema</kind>
        <symbol>HealthCheckSchema, HealthCheckListResponseSchema, HealthCheckPingResponseSchema</symbol>
        <reason>Shared Zod schemas - used by web, mobile, and server for type safety</reason>
      </artifact>
      <artifact>
        <path>packages/api-client/src/lib/api-client.ts</path>
        <kind>client</kind>
        <symbol>createApiClient</symbol>
        <reason>Type-safe API client factory - used by both web and mobile</reason>
      </artifact>
      <artifact>
        <path>apps/web-e2e/src/health.spec.ts</path>
        <kind>test</kind>
        <symbol>health E2E tests</symbol>
        <reason>Playwright E2E tests for web health page - reference for expected behavior</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package>openapi-fetch</package>
        <version>^0.14.0</version>
        <purpose>Type-safe REST API client from OpenAPI spec</purpose>
      </node>
      <node>
        <package>zod</package>
        <version>^3.25.0</version>
        <purpose>Schema validation for API requests/responses</purpose>
      </node>
      <node>
        <package>@prisma/client</package>
        <version>^6.17.0</version>
        <purpose>Database ORM for Supabase PostgreSQL</purpose>
      </node>
      <node>
        <package>expo</package>
        <version>~54.0.0</version>
        <purpose>Mobile development framework</purpose>
      </node>
      <node>
        <package>expo-constants</package>
        <version>bundled</version>
        <purpose>Environment configuration for API URL</purpose>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="validation-only">This is a VALIDATION story - no code modifications. All testing is manual.</constraint>
    <constraint type="prerequisite">Story 6.3 must be complete (mobile health check screen implemented)</constraint>
    <constraint type="environment">iOS Simulator uses http://localhost:4000/api</constraint>
    <constraint type="environment">Android Emulator uses http://10.0.2.2:4000/api (localhost alias)</constraint>
    <constraint type="sync-model">Walking skeleton uses refresh-based sync, not real-time (no WebSockets)</constraint>
    <constraint type="documentation">All validation results must be documented with screenshots or video</constraint>
    <constraint type="data-format">UUIDs must be valid v4 format, timestamps must be ISO 8601</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>GET /api/health</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/health → { healthChecks: HealthCheck[] }</signature>
      <path>apps/server/src/routes/health.ts</path>
    </interface>
    <interface>
      <name>POST /api/health/ping</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/health/ping { message?: string } → { healthCheck: HealthCheck }</signature>
      <path>apps/server/src/routes/health.ts</path>
    </interface>
    <interface>
      <name>HealthCheck</name>
      <kind>type</kind>
      <signature>{ id: string (UUID), message: string, timestamp: string (ISO 8601) }</signature>
      <path>packages/schemas/src/lib/health.schema.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      This is a MANUAL VALIDATION story. No automated tests are written. The validation process itself is the "test" - systematically executing test cases across platforms and documenting results. Use the validation checklist in Dev Notes to ensure thorough coverage.
    </standards>
    <locations>
      <location>apps/web-e2e/src/health.spec.ts (reference for expected web behavior)</location>
      <location>Dev Agent Record in story file (validation results documentation)</location>
    </locations>
    <ideas>
      <idea ac="6.4.1,6.4.2">Web-to-Mobile and Mobile-to-Web sync tests - create on one platform, verify on other after refresh</idea>
      <idea ac="6.4.3,6.4.4">Data integrity checks - compare raw API responses from both platforms for exact match</idea>
      <idea ac="6.4.5">Screenshot evidence - capture both platforms showing same data side-by-side</idea>
      <idea ac="6.4.6">Latency observations - measure time from create to visible after refresh (target: &lt;1 second)</idea>
      <idea>Cross-browser validation - test with different iOS Simulator devices and Android SDK versions</idea>
      <idea>Stress test - create 5+ health checks alternating platforms, verify ordering preserved</idea>
    </ideas>
  </tests>
</story-context>
