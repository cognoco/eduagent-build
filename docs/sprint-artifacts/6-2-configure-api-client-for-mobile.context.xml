<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>2</storyId>
    <title>Configure API Client for Mobile</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-13</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/6-2-configure-api-client-for-mobile.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>mobile developer</asA>
    <iWant>the API client working in the mobile app with environment-aware URL configuration</iWant>
    <soThat>I can make type-safe API calls from mobile to the Express server</soThat>
    <tasks>
      <task id="1" title="Create API Client Factory">
        <subtask>1.1 Create apps/mobile/src/lib/api.ts file</subtask>
        <subtask>1.2 Import createClient from openapi-fetch</subtask>
        <subtask>1.3 Import paths type from @nx-monorepo/api-client</subtask>
        <subtask>1.4 Configure base URL using expo-constants</subtask>
        <subtask>1.5 Export apiClient instance with correct typing</subtask>
      </task>
      <task id="2" title="Configure Environment-Aware URL">
        <subtask>2.1 Update apps/mobile/app.json with extra.apiUrl config</subtask>
        <subtask>2.2 Configure iOS Simulator URL: http://localhost:4000/api</subtask>
        <subtask>2.3 Configure Android Emulator URL: http://10.0.2.2:4000/api</subtask>
        <subtask>2.4 Configure fallback for production/staging (Railway URL)</subtask>
        <subtask>2.5 Document environment variable strategy in Dev Notes</subtask>
      </task>
      <task id="3" title="Verify TypeScript Path Resolution">
        <subtask>3.1 Run pnpm exec nx run mobile:typecheck</subtask>
        <subtask>3.2 Confirm @nx-monorepo/api-client import resolves correctly</subtask>
        <subtask>3.3 Confirm paths type provides autocomplete for API endpoints</subtask>
        <subtask>3.4 Document any Metro resolver configuration needed</subtask>
      </task>
      <task id="4" title="Test API Call Integration">
        <subtask>4.1 Start Express server: pnpm exec nx run server:serve</subtask>
        <subtask>4.2 Add test API call in mobile app (e.g., in app/index.tsx temporarily)</subtask>
        <subtask>4.3 Test on iOS Simulator - verify GET /api/health succeeds</subtask>
        <subtask>4.4 Test on Android Emulator - verify GET /api/health succeeds</subtask>
        <subtask>4.5 Verify response data matches expected schema</subtask>
        <subtask>4.6 Remove temporary test code after validation</subtask>
      </task>
      <task id="5" title="Validate Type Safety">
        <subtask>5.1 Intentionally write incorrect API call (wrong endpoint)</subtask>
        <subtask>5.2 Verify TypeScript shows compile-time error</subtask>
        <subtask>5.3 Intentionally pass wrong request body type</subtask>
        <subtask>5.4 Verify TypeScript shows compile-time error</subtask>
        <subtask>5.5 Document type safety validation in Dev Notes</subtask>
      </task>
      <task id="6" title="Document Networking Configuration">
        <subtask>6.1 Document localhost differences (iOS vs Android)</subtask>
        <subtask>6.2 Document how to test against staging API</subtask>
        <subtask>6.3 Document common networking errors and solutions</subtask>
        <subtask>6.4 Update README or create mobile networking guide</subtask>
      </task>
      <task id="7" title="Update Sprint Status">
        <subtask>7.1 Update sprint-status.yaml: set 6-2 status to done</subtask>
        <subtask>7.2 Document any issues or workarounds in Dev Notes</subtask>
        <subtask>7.3 Note any differences from web API client configuration</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-6.2.1">apiClient factory created in apps/mobile/src/lib/api.ts with correct configuration</criterion>
    <criterion id="AC-6.2.2">Environment-aware URL configuration working for iOS Simulator, Android Emulator, and production</criterion>
    <criterion id="AC-6.2.3">Test API call succeeds from mobile app (GET /api/health returns data)</criterion>
    <criterion id="AC-6.2.4">Type safety preserved - compile-time errors occur on wrong API usage</criterion>
    <criterion id="AC-6.2.5">Import path @nx-monorepo/api-client resolves correctly in mobile app</criterion>
    <criterion id="AC-6.2.6">Networking configuration documented for local development</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/sprint-artifacts/tech-spec-epic-6.md" title="Epic 6 Technical Specification" section="APIs and Interfaces" snippet="Mobile consumes existing REST+OpenAPI endpoints. API client configuration pattern using openapi-fetch with expo-constants for environment-aware base URL."/>
      <doc path="docs/sprint-artifacts/epic-6-design-decisions.md" title="Epic 6 Design Decisions" section="D5: API Client Approach" snippet="Use existing openapi-fetch from @nx-monorepo/api-client without modification. React Native provides global fetch implementation. Zero additional dependencies."/>
      <doc path="docs/epics.md" title="Epic Breakdown" section="Story 6.2: Configure API Client for Mobile" snippet="As a mobile developer, I want the API client working in the mobile app, So that I can make type-safe API calls from mobile."/>
      <doc path="docs/architecture.md" title="Architecture" section="Project Structure" snippet="packages/api-client/ contains REST API client with src/index.ts client factory and generated/ OpenAPI-generated types."/>
    </docs>
    <code>
      <artifact path="packages/api-client/src/lib/api-client.ts" kind="factory" symbol="createApiClient" lines="54-75" reason="Existing API client factory pattern - mobile should follow same pattern with mobile-specific baseUrl configuration"/>
      <artifact path="packages/api-client/src/index.ts" kind="barrel" symbol="paths" lines="5" reason="Exports OpenAPI types that mobile app will import for type-safe API calls"/>
      <artifact path="packages/api-client/src/gen/openapi.ts" kind="generated" symbol="paths, components" reason="Generated OpenAPI types from server spec - provides endpoint definitions and request/response types"/>
      <artifact path="tsconfig.base.json" kind="config" symbol="compilerOptions" reason="Base TypeScript config - mobile app inherits path resolution settings via composite project references"/>
    </code>
    <dependencies>
      <ecosystem name="node">
        <package name="openapi-fetch" version="^0.14.0" purpose="Type-safe REST client - already in workspace, used by api-client package"/>
        <package name="expo-constants" version="bundled" purpose="Access app.json extra config - bundled with Expo SDK 54"/>
        <package name="expo" version="~54.0.0" purpose="Expo SDK providing React Native framework and CLI"/>
        <package name="react-native" version="0.81.5" purpose="Mobile framework - provides global fetch implementation"/>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="architecture">Mobile app depends on shared packages (api-client, schemas) - same as web. No app-to-app imports (mobile does not import from web).</constraint>
    <constraint source="epic-6-design-decisions">Use existing openapi-fetch library without modification. React Native provides global fetch implementation. Zero additional dependencies.</constraint>
    <constraint source="tech-spec">API server remains security boundary - mobile uses REST+OpenAPI like web. Input validation via Zod schemas (same as web).</constraint>
    <constraint source="adopted-patterns">Tests co-located in src/ next to source files (.spec.ts or .test.tsx). Follow Next.js 15 conventions.</constraint>
    <constraint source="sdk-54">Expo SDK 54 is required by @nx/expo plugin. Use Legacy Architecture (SDK 54 is last supporting it).</constraint>
  </constraints>

  <interfaces>
    <interface name="createApiClient" kind="function" signature="(config: ApiClientConfig = {}) =&gt; ApiClient" path="packages/api-client/src/lib/api-client.ts"/>
    <interface name="ApiClientConfig" kind="type" signature="{ baseUrl?: string; headers?: Record&lt;string, string&gt;; fetch?: typeof fetch; }" path="packages/api-client/src/lib/api-client.ts"/>
    <interface name="GET /api/health" kind="REST endpoint" signature="GET /api/health =&gt; { data: HealthCheck[] }" path="apps/server/src/routes/health.ts"/>
    <interface name="POST /api/health" kind="REST endpoint" signature="POST /api/health { message: string } =&gt; { data: HealthCheck }" path="apps/server/src/routes/health.ts"/>
    <interface name="paths" kind="type" signature="OpenAPI paths type with all endpoint definitions" path="packages/api-client/src/gen/openapi.ts"/>
  </interfaces>

  <tests>
    <standards>Jest 30 with @testing-library/react-native for mobile component testing. Unit tests co-located in src/ directory next to source files. Follow existing api-client package testing patterns. Coverage measured but not enforced during walking skeleton phase.</standards>
    <locations>
      <location>apps/mobile/src/**/*.spec.ts</location>
      <location>apps/mobile/src/**/*.spec.tsx</location>
      <location>apps/mobile/src/**/*.test.ts</location>
      <location>apps/mobile/src/**/*.test.tsx</location>
    </locations>
    <ideas>
      <idea acRef="AC-6.2.1">Unit test: apiClient factory creates client with correct baseUrl from Constants.expoConfig.extra.apiUrl</idea>
      <idea acRef="AC-6.2.2">Unit test: getApiUrl() returns correct URL for iOS (localhost) vs Android (10.0.2.2) in __DEV__ mode</idea>
      <idea acRef="AC-6.2.3">Integration test: Mock API call to /api/health returns expected response structure</idea>
      <idea acRef="AC-6.2.4">Type test: Verify TypeScript compilation fails when passing invalid endpoint path to apiClient.GET()</idea>
      <idea acRef="AC-6.2.5">Unit test: Import @nx-monorepo/api-client resolves correctly (implicit via successful test execution)</idea>
    </ideas>
  </tests>
</story-context>
